# Plugin Architecture v2

  

> 最近更新于 2025.01.20

  

## 插件内部规则

  

### 记录保存

  

对于收集的记录，插件会保存到当前 `workspace` 的 `virtualme-logs` 文件夹中

  

文件命名规则为：`版本_年-月-日 时.分.秒.json`

  

例如：`v0.2.3_2025-01-19 20.53.47.json`

  

## 插件命令

  

命令调用：Windows 环境下在 IDE 中按 `Ctrl + Shift + P` 快捷键打开命令面板，输入对应命令即可执行

  

### virtualme.activate

  

- 作用：激活插件

- 快捷键：Ctrl + Alt + V

  

### virtualme.start

  

- 作用：插件开始记录

- 无快捷键

  

### virtualme.stop

  

- 作用：插件停止记录

- 无快捷键

  

### virtualme.clear

  

- 作用：清空插件当前缓存的记录

- 可以在插件界面上点击按钮执行该命令，无快捷键

  

### virtualme.savelog

  

- 作用：保存插件当前缓存的记录

- 快捷键：Ctrl + Alt + S

  

### virtualme.register.tasktype

  

- 作用：注册任务类型，用于增加自定义的任务的类型数量

- 在插件界面操作时插件会根据需要自行调用，不要通过命令面板主动调用该命令

  

### virtualme.settask.*

  

- 作用：用于设置当前所处任务状态

- 内部命令，不要自行调用

  

## 事件总览

  

> 带星号的表示测试出有问题

  

### 文件级事件

  
| 编号 | 名称 | 符号 | 最近测试 | 触发条件 |
| ---- | -------------- | -------------------- | ---------- | ---------------------------- |
| 1-1 | 打开文本文件 | `OpenTextDocument` | 2025.01.20 | 打开文本文件（忽略特定文件） |
| 1-2 | 关闭文本文件 | `CloseTextDocument` | 2025.01.20 | 关闭文本文件（忽略特定文件） |
| 1-3 | 切换文本编辑器 | `ChangeTextDocument` | 2025.01.20 | 切换/关闭文本文件 |
| 1-4 | 新建文件 | `CreateFile` | 2025.01.20 | 新建文件（忽略特定文件） |
| 1-5 | 删除文件 | `DeleteFile` | 2025.01.20 | 删除文件（忽略特定文件） |
| 1-6 | 保存文件 | `SaveFile` | 2025.01.20 | 保存文件（忽略特定文件） |
| 1-7 | 重命名文件 | `RenameFile` | 2025.01.20 | 重命名文件（忽略特定文件） |
| 1-8 | 移动文件 | `MoveFile` | 2025.01.20 | 移动文件（忽略特定文件） |

  

> 系统性问题：过滤规则可能会误过滤不应该被过滤的内容

>

  

### 文本内容相关事件

  

| 编号 | 名称 | 符号 | 最近测试 | 触发条件 |
| ---- | ------------ | -------------------- | ---------- | ---------------------------- |
| 2-1* | 添加文件内容 | `AddTextDocument` | 2025.01.20 | 添加文件内容 |
| 2-2* | 删除文件内容 | `DeleteTextDocument` | 2025.01.20 | 删除文件内容 |
| 2-3 | 修改文件内容 | `EditTextDocument` | 2025.01.20 | 修改文件内容 |
| 2-4 | 重做文件内容 | `RedoTextDocument` | 2025.01.20 | 重做文件内容 |
| 2-5 | 撤销文件内容 | `UndoTextDocument` | 2025.01.20 | 撤销文件内容 |
| 2-6* | 选中文本 | `SelectText` | 2025.01.20 | （鼠标、键盘或命令）选中文本 |
| 2-7 | 鼠标悬停 | `MouseHover` | 2025.01.20 | 鼠标在代码上悬停1秒以上 |

  

> 2-1 & 2-2 合并记录粗测有问题

>

> 2-6 保存选中操作会有滞后性

  

**说明：**

  

1. 鼠标点击操作无法被插件监听，技术上无法实现。而 `Ctrl + 鼠标左键` 实际上执行内置的”跳转到定义“或”查看定义“命令，因此可以新增指令绑定这两个命令的快捷键，实现部分功能，但是缺点是：必须要按快捷键或执行对应指令才能激活命令，而且一旦用户更改了对应的快捷键，那么将收集到错误的信息。

2. 2-1 & 2-2 会对部分编辑操作进行合并，合并逻辑见源代码

3. 2-6 会对选中操作进行合并，合并逻辑见代码

  

### 终端事件

  

| 编号   | 名称        | 符号                       | 最近测试       | 触发条件     |
| ---- | --------- | ------------------------ | ---------- | -------- |
| 3-1  | 打开终端      | `OpenTerminal`           | 2025.01.20 | 打开终端     |
| 3-2  | 关闭终端      | `CloseTerminal`          | 2025.01.20 | 关闭终端     |
| 3-3  | 切换终端      | `ChangeActiveTerminal`   | 2025.01.20 | 切换终端     |
| 3-4* | 执行终端命令    | `ExecuteTerminalCommand` | 2025.01.20 | 在终端执行命令  |
| 3-5  | 获取调试控制台输出 | `DebugConsoleOutput`     | LSW        | （当前存在问题） |

  

> 3-4 命令的执行结果输出无法完全正确记录

  

### 命令执行事件

  

| 编号 | 名称 | 符号 | 最近测试 | 触发条件 |
|-----|-------| ------------------------ |------| -------- |
| 4-1 | 执行菜单项 | `ExecuteMenuItem` | | |

  
  
  

### 其他事件

  

| 编号 | 名称 | 符号 | 开发人员 | 是否实现 |

| ---- | -------- | ---- | -------- | -------- |

| 4-1 | 鼠标滚动 | | | X |

| 4-2 | 版本控制 | | | X |

  

## 事件属性

  

[log-item.xmind](../raw/log-item.xmind)

  

### 输出结构

  

![](../raw/log-item-surface.png)

  

### 实际结构

  

![](../raw/log-item.png)

  

### 通用属性

  

以下属性为通用属性，每个事件类型都会包含

  

- `id: number` 在本次记录中的序号

- `timeStamp: string` 记录本事件的时间戳

- `eventType: EventType` 事件类型

- `artifact: Artifact` 操作工件

- `name: string` 工件名称

- `type: ArtifactType` 工件类型

- `hierarchy?: Artifact[]` 该工件的层级（可能没有）

| 问题/API | 输出 |
| --------------------------------------- | ------------------------------------------------------------ |
| 代码变更的摘要，可以指定文件/文件夹范围 | 范围内涉及的文件的编辑历史总结，通过代码快照+LLM实现 |
| 终端命令的摘要，可以指定命令类型 | 对应类型的命令的执行历史总结，成功与否，控制台输出内容总结，通过匹配+LLM实现 |
| 开发区域可视化 | 一张repo的树形图，节点精确到artifact或file，节点颜色或属性表明编辑强度或其他编辑细节 |
| 获取宏观总结 | 与原方案一致，先模式识别，根据模式，总结对应的内容。 |


| 问题/API        | 输出                             |
| ------------- | ------------------------------ |
| 哪些工件最可能被下一步操作 | 工件路径+行号范围                      |
| 哪些工件与当前开发最相关  | 工件路径+行号范围                      |
| 获取宏观预测        | 先模式识别+新旧件预测，再检索+计算，输出工件路径+行号范围 |



| 问题       | 输出                   |
| -------- | -------------------- |
| 我的编码能力   | 与该能力相关的指标，提供可视化图表，下同 |
| 我的项目熟悉程度 |                      |
| 我解决问题的能力 |                      |
| 对我有什么建议  |                      |